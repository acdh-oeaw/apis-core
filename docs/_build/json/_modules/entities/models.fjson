{"title": "entities.models", "current_page_name": "_modules/entities/models", "body": "<h1>Source code for entities.models</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"k\">import</span> <span class=\"n\">models</span>\n<span class=\"c1\">#from reversion import revisions as reversion</span>\n<span class=\"kn\">import</span> <span class=\"nn\">reversion</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.signals</span> <span class=\"k\">import</span> <span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">m2m_changed</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.dispatch</span> <span class=\"k\">import</span> <span class=\"n\">receiver</span>\n<span class=\"kn\">from</span> <span class=\"nn\">guardian.shortcuts</span> <span class=\"k\">import</span> <span class=\"n\">assign_perm</span><span class=\"p\">,</span> <span class=\"n\">remove_perm</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">metainfo.models</span> <span class=\"k\">import</span> <span class=\"n\">TempEntityClass</span><span class=\"p\">,</span> <span class=\"n\">Uri</span><span class=\"p\">,</span> <span class=\"n\">Text</span><span class=\"p\">,</span> <span class=\"n\">Collection</span>\n<span class=\"kn\">from</span> <span class=\"nn\">labels.models</span> <span class=\"k\">import</span> <span class=\"n\">Label</span>\n<span class=\"kn\">from</span> <span class=\"nn\">vocabularies.models</span> <span class=\"k\">import</span> <span class=\"p\">(</span><span class=\"n\">ProfessionType</span><span class=\"p\">,</span> <span class=\"n\">PlaceType</span><span class=\"p\">,</span> <span class=\"n\">InstitutionType</span><span class=\"p\">,</span>\n    <span class=\"n\">EventType</span><span class=\"p\">,</span> <span class=\"n\">Title</span><span class=\"p\">,</span> <span class=\"n\">WorkType</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">apis.settings.base</span> <span class=\"k\">import</span> <span class=\"n\">BASE_URI</span>\n<span class=\"kn\">from</span> <span class=\"nn\">apis.settings.base</span> <span class=\"k\">import</span> <span class=\"n\">BASE_DIR</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">re</span>\n<span class=\"kn\">import</span> <span class=\"nn\">unicodedata</span>\n\n\n<span class=\"nd\">@reversion</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"n\">follow</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;tempentityclass_ptr&#39;</span><span class=\"p\">])</span>\n<div class=\"viewcode-block\" id=\"Person\"><a class=\"viewcode-back\" href=\"../../../modules/entities/#entities.models.Person\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Person</span><span class=\"p\">(</span><span class=\"n\">TempEntityClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot; A temporalized entity to model a human beeing.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">GENDER_CHOICES</span> <span class=\"o\">=</span> <span class=\"p\">((</span><span class=\"s1\">&#39;female&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;female&#39;</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"s1\">&#39;male&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;male&#39;</span><span class=\"p\">))</span>\n    <span class=\"n\">first_name</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">CharField</span><span class=\"p\">(</span>\n        <span class=\"n\">max_length</span><span class=\"o\">=</span><span class=\"mi\">255</span><span class=\"p\">,</span>\n        <span class=\"n\">help_text</span><span class=\"o\">=</span><span class=\"s1\">&#39;The persons\u00b4s forename. In case of more then one name...&#39;</span><span class=\"p\">,</span>\n        <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">profession</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ManyToManyField</span><span class=\"p\">(</span><span class=\"n\">ProfessionType</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">title</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ManyToManyField</span><span class=\"p\">(</span><span class=\"n\">Title</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">gender</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">CharField</span><span class=\"p\">(</span>\n        <span class=\"n\">max_length</span><span class=\"o\">=</span><span class=\"mi\">15</span><span class=\"p\">,</span> <span class=\"n\">choices</span><span class=\"o\">=</span><span class=\"n\">GENDER_CHOICES</span><span class=\"p\">,</span>\n        <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">, </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">, </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"s2\">&quot;no surename provided&quot;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;no name provided&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create_uri</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"s1\">r&#39;^[0-9]*$&#39;</span><span class=\"p\">,</span> <span class=\"n\">uri</span><span class=\"p\">):</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Person</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Person</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">uri__uri</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">p</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">!=</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"s1\">&#39;NFC&#39;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">):</span>    <span class=\"c1\">#secure correct unicode encoding</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span> <span class=\"o\">=</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"s1\">&#39;NFC&#39;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first_name</span><span class=\"p\">)</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">Person</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span></div>\n\n\n<span class=\"nd\">@reversion</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"n\">follow</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;tempentityclass_ptr&#39;</span><span class=\"p\">])</span>\n<div class=\"viewcode-block\" id=\"Place\"><a class=\"viewcode-back\" href=\"../../../modules/entities/#entities.models.Place\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Place</span><span class=\"p\">(</span><span class=\"n\">TempEntityClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot; A temporalized entity to model a place&quot;&quot;&quot;</span>\n\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ForeignKey</span><span class=\"p\">(</span><span class=\"n\">PlaceType</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">lat</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">FloatField</span><span class=\"p\">(</span><span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">verbose_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;latitude&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">lng</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">FloatField</span><span class=\"p\">(</span><span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">verbose_name</span><span class=\"o\">=</span><span class=\"s1\">&#39;longitude&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;no name provided&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create_uri</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"s1\">r&#39;^[0-9]*$&#39;</span><span class=\"p\">,</span> <span class=\"n\">uri</span><span class=\"p\">):</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Place</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Place</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">uri__uri</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">p</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span></div>\n\n\n<span class=\"nd\">@reversion</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"n\">follow</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;tempentityclass_ptr&#39;</span><span class=\"p\">])</span>\n<div class=\"viewcode-block\" id=\"Institution\"><a class=\"viewcode-back\" href=\"../../../modules/entities/#entities.models.Institution\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Institution</span><span class=\"p\">(</span><span class=\"n\">TempEntityClass</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ForeignKey</span><span class=\"p\">(</span><span class=\"n\">InstitutionType</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">homepage</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">URLField</span><span class=\"p\">(</span><span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create_uri</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"s1\">r&#39;^[0-9]*$&#39;</span><span class=\"p\">,</span> <span class=\"n\">uri</span><span class=\"p\">):</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Institution</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Institution</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">uri__uri</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n                <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">p</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;returned false&#39;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span></div>\n\n\n<span class=\"nd\">@reversion</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"n\">follow</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;tempentityclass_ptr&#39;</span><span class=\"p\">])</span>\n<div class=\"viewcode-block\" id=\"Event\"><a class=\"viewcode-back\" href=\"../../../modules/entities/#entities.models.Event\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Event</span><span class=\"p\">(</span><span class=\"n\">TempEntityClass</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ForeignKey</span><span class=\"p\">(</span><span class=\"n\">EventType</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create_uri</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"s1\">r&#39;^[0-9]*$&#39;</span><span class=\"p\">,</span> <span class=\"n\">uri</span><span class=\"p\">):</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Event</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Event</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">uri__uri</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">p</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span></div>\n\n\n<span class=\"nd\">@reversion</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"n\">follow</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;tempentityclass_ptr&#39;</span><span class=\"p\">])</span>\n<div class=\"viewcode-block\" id=\"Work\"><a class=\"viewcode-back\" href=\"../../../modules/entities/#entities.models.Work\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Work</span><span class=\"p\">(</span><span class=\"n\">TempEntityClass</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">ForeignKey</span><span class=\"p\">(</span><span class=\"n\">WorkType</span><span class=\"p\">,</span> <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">null</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create_uri</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"s1\">r&#39;^[0-9]*$&#39;</span><span class=\"p\">,</span> <span class=\"n\">uri</span><span class=\"p\">):</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Work</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">p</span> <span class=\"o\">=</span> <span class=\"n\">Work</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">uri__uri</span><span class=\"o\">=</span><span class=\"n\">uri</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">p</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span></div>\n\n\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Event</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_default_uri&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Work</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_default_uri&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Institution</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_default_uri&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Person</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_default_uri&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">post_save</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Place</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_default_uri&quot;</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">create_default_uri</span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"n\">uri</span> <span class=\"o\">=</span> <span class=\"n\">Uri</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">entity</span><span class=\"o\">=</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">uri</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n        <span class=\"n\">uri2</span> <span class=\"o\">=</span> <span class=\"n\">Uri</span><span class=\"p\">(</span>\n                <span class=\"n\">uri</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">((</span><span class=\"n\">BASE_URI</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">))),</span>\n                <span class=\"n\">domain</span><span class=\"o\">=</span><span class=\"s1\">&#39;apis default&#39;</span><span class=\"p\">,</span>\n                <span class=\"n\">entity</span><span class=\"o\">=</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n        <span class=\"n\">uri2</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Event</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_object_permissions&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Work</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_object_permissions&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Institution</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_object_permissions&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Person</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_object_permissions&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Place</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;create_object_permissions&quot;</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">create_object_permissions</span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;action&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;pre_add&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">perms</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">j</span> <span class=\"ow\">in</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;model&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;pk_set&#39;</span><span class=\"p\">]):</span>\n            <span class=\"n\">perms</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">j</span><span class=\"o\">.</span><span class=\"n\">groups_allowed</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n        <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">perms</span><span class=\"p\">:</span>\n            <span class=\"n\">assign_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;change_&#39;</span><span class=\"o\">+</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">__class__</span><span class=\"o\">.</span><span class=\"n\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">(),</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">)</span>\n            <span class=\"n\">assign_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;delete_&#39;</span><span class=\"o\">+</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">__class__</span><span class=\"o\">.</span><span class=\"n\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">(),</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;action&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;post_remove&#39;</span><span class=\"p\">:</span>\n        <span class=\"n\">perms</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">perms_keep</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">j</span> <span class=\"ow\">in</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;model&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;pk_set&#39;</span><span class=\"p\">]):</span>\n            <span class=\"n\">perms</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">j</span><span class=\"o\">.</span><span class=\"n\">groups_allowed</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n        <span class=\"k\">for</span> <span class=\"n\">u</span> <span class=\"ow\">in</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">collection</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n            <span class=\"n\">perms_keep</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">u</span><span class=\"o\">.</span><span class=\"n\">groups_allowed</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">())</span>\n        <span class=\"n\">rm_perms</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">perms</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">perms_keep</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">rm_perms</span><span class=\"p\">:</span>\n            <span class=\"n\">remove_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;change_&#39;</span><span class=\"o\">+</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">__class__</span><span class=\"o\">.</span><span class=\"n\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">(),</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">)</span>\n            <span class=\"n\">remove_perm</span><span class=\"p\">(</span><span class=\"s1\">&#39;delete_&#39;</span><span class=\"o\">+</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">__class__</span><span class=\"o\">.</span><span class=\"n\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">(),</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@receiver</span><span class=\"p\">(</span><span class=\"n\">m2m_changed</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">Collection</span><span class=\"o\">.</span><span class=\"n\">groups_allowed</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span> <span class=\"n\">dispatch_uid</span><span class=\"o\">=</span><span class=\"s2\">&quot;add_usergroup_collection&quot;</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">add_usergroup_collection</span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;action&#39;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;pre_add&#39;</span><span class=\"p\">:</span>\n        <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;model&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s1\">&#39;pk_set&#39;</span><span class=\"p\">]):</span>\n            <span class=\"k\">for</span> <span class=\"n\">z</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"s1\">&#39;change&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;delete&#39;</span><span class=\"p\">]:</span>\n                <span class=\"k\">for</span> <span class=\"n\">y</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"n\">Person</span><span class=\"p\">,</span> <span class=\"n\">Institution</span><span class=\"p\">,</span> <span class=\"n\">Place</span><span class=\"p\">,</span> <span class=\"n\">Event</span><span class=\"p\">,</span> <span class=\"n\">Work</span><span class=\"p\">]:</span>\n                    <span class=\"n\">assign_perm</span><span class=\"p\">(</span>\n                        <span class=\"n\">z</span><span class=\"o\">+</span><span class=\"s1\">&#39;_&#39;</span><span class=\"o\">+</span><span class=\"n\">y</span><span class=\"o\">.</span><span class=\"n\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">(),</span>\n                        <span class=\"n\">x</span><span class=\"p\">,</span>\n                        <span class=\"n\">y</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">collection</span><span class=\"o\">=</span><span class=\"n\">instance</span><span class=\"p\">))</span>\n</pre></div>", "parents": [{"title": "Module code", "link": "../../"}], "sidebars": null, "alabaster_version": "0.7.10", "customsidebar": null}