

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>apis_core.apis_entities.models &mdash; APIS 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> APIS
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_model.html">Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internal_api.html">Internal API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_documentation.html">User documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">APIS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>apis_core.apis_entities.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for apis_core.apis_entities.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># from reversion import revisions as reversion</span>
<span class="kn">import</span> <span class="nn">reversion</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">m2m_changed</span><span class="p">,</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">guardian.shortcuts</span> <span class="kn">import</span> <span class="n">assign_perm</span><span class="p">,</span> <span class="n">remove_perm</span>

<span class="kn">from</span> <span class="nn">apis_core.apis_metainfo.models</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">TempEntityClass</span><span class="p">,</span> <span class="n">Uri</span>
<span class="kn">from</span> <span class="nn">apis_core.apis_vocabularies.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EventType</span><span class="p">,</span>
    <span class="n">InstitutionType</span><span class="p">,</span>
    <span class="n">PlaceType</span><span class="p">,</span>
    <span class="n">ProfessionType</span><span class="p">,</span>
    <span class="n">Title</span><span class="p">,</span>
    <span class="n">WorkType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">apis_core.helper_functions</span> <span class="kn">import</span> <span class="n">EntityRelationFieldGenerator</span>

<span class="n">BASE_URI</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;APIS_BASE_URI&quot;</span><span class="p">,</span> <span class="s2">&quot;http://apis.info/&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="AbstractEntity"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity">[docs]</a><span class="k">class</span> <span class="nc">AbstractEntity</span><span class="p">(</span><span class="n">TempEntityClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract super class which encapsulates common logic between the different entity kinds and provides various methods</span>
<span class="sd">    relating to either all or a specific entity kind.</span>

<span class="sd">    Most of the class methods are designed to be used in the sublcass as they are considering contexts which depend on</span>
<span class="sd">    the subclass entity type. So they are to be understood in that dynamic context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Placeholder for list filter classes attached to each entity later</span>
    <span class="n">list_filter_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">create_relation_methods_from_manytomany_fields</span><span class="p">()</span>

    <span class="c1"># Methods dealing with individual data retrievals of instances</span>
    <span class="c1">####################################################################################################################</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Person</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;no surename provided&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;no name provided&quot;</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;no name provided&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[0-9]*$&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri__uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found no object corresponding to given uri.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_list_filter_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">list_filter_class</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">list_filter_class</span> <span class="o">=</span> <span class="n">list_filter_class</span>

    <span class="c1"># Various Methods enabling convenient shortcuts between entities, relations, fields, etc</span>
    <span class="c1">####################################################################################################################</span>

<div class="viewcode-block" id="AbstractEntity.create_relation_methods_from_manytomany_fields"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.create_relation_methods_from_manytomany_fields">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_relation_methods_from_manytomany_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates methods on an entity class with which other related entities can be called without the need to consider</span>
<span class="sd">        potential self-references (the A and B sides therein).</span>

<span class="sd">        The resulting methods follow the syntax:</span>
<span class="sd">        &lt;entity&gt;.get_related_&lt;entity&gt;_instances()</span>

<span class="sd">        e.g. for Person:</span>
<span class="sd">        person.get_related_work_instances()</span>
<span class="sd">        or</span>
<span class="sd">        person.get_related_person_instances()</span>

<span class="sd">        Note that with these methods it is not necessary to differentiate between A and B entities when self-relations exist.</span>

<span class="sd">        The result of any such method call is the queryset of the related entities.</span>
<span class="sd">        (And not a ManyToManyManager as is the case when calling &lt;entity&gt;.&lt;entity&gt;_set where in the case of self-relation</span>
<span class="sd">        it must be differentiated between A and B entities, e.g. person.personA_set )</span>

<span class="sd">        It was not possible to my understanding to change managers in such a way that two (the A and the B) could be combined</span>
<span class="sd">        into one manager. Hence these additional shortcut methods.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">create_function_from_manytomany_field_to_other_entity</span><span class="p">(</span>
            <span class="n">entity_manytomany_field</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            creates the individual method from a ManyToMany field by calling the manager&#39;s objects.all()</span>

<span class="sd">            This method creation has to be done here in a separate method, so that it can be called once before assignment</span>
<span class="sd">            as otherwise the variable &#39;entity_name&#39; in the loop below changes with each iteration and with that also the</span>
<span class="sd">            method references (due to python&#39;s &quot;late binding&quot;).</span>
<span class="sd">            A method call in between thus forces the content of &#39;entity_name&#39; to be assigned for good to the</span>
<span class="sd">            respective class ( = forced early binding).</span>
<span class="sd">            For more details on this: https://stackoverflow.com/questions/3431676/creating-functions-in-a-loop</span>

<span class="sd">            :param entity_manytomany_field: the ManyToManyManager to another model</span>
<span class="sd">            :return: method which will call the managers&#39;s objects.all() method</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_manytomany_field</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">create_function_from_manytomany_field_to_self_entity</span><span class="p">(</span>
            <span class="n">entityA_manytomany_field</span><span class="p">,</span> <span class="n">entityB_manytomany_field</span>
        <span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Same method as above, but with two managers instead of one for the case of self-relations.</span>

<span class="sd">            Both managers&#39; objects.all() methods are called and their queryset results are unionised for the</span>
<span class="sd">            shortcut method of an entity to its own related entities.</span>

<span class="sd">            :param entityA_manytomany_field: ManyToManyManager to entity A in a self-relation</span>
<span class="sd">            :param entityB_manytomany_field: ManyToManyManager to entity A in a self-relation</span>
<span class="sd">            :return: method to call both and return the distinct union of them</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entityA_manytomany_field</span><span class="p">)</span>
                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entityB_manytomany_field</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">entity_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_entity_names</span><span class="p">():</span>
            <span class="c1"># Iterate over each entity defined within this models&#39; module</span>

            <span class="n">related_entity_function_name</span> <span class="o">=</span> <span class="s2">&quot;get_related_&quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;_instances&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">related_entity_function_name</span><span class="p">):</span>

                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_name</span><span class="p">:</span>
                    <span class="c1"># If the related entity is the same as this current one, then set the names of the related functions</span>
                    <span class="c1"># to A and B and also combine them into one function where both A and B are returned.</span>

                    <span class="n">related_entityA_function_name</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;get_related_&quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;A_instances&quot;</span>
                    <span class="p">)</span>
                    <span class="n">related_entityB_function_name</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;get_related_&quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;B_instances&quot;</span>
                    <span class="p">)</span>
                    <span class="n">entityA_manytomany_field</span> <span class="o">=</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;A_set&quot;</span>
                    <span class="n">entityB_manytomany_field</span> <span class="o">=</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;B_set&quot;</span>

                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="p">,</span>
                        <span class="n">related_entityA_function_name</span><span class="p">,</span>
                        <span class="n">create_function_from_manytomany_field_to_other_entity</span><span class="p">(</span>
                            <span class="n">entityA_manytomany_field</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="p">,</span>
                        <span class="n">related_entityB_function_name</span><span class="p">,</span>
                        <span class="n">create_function_from_manytomany_field_to_other_entity</span><span class="p">(</span>
                            <span class="n">entityB_manytomany_field</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="p">,</span>
                        <span class="n">related_entity_function_name</span><span class="p">,</span>
                        <span class="n">create_function_from_manytomany_field_to_self_entity</span><span class="p">(</span>
                            <span class="n">entityA_manytomany_field</span><span class="p">,</span> <span class="n">entityB_manytomany_field</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the related entity is a different one, then just build on the usual names</span>

                    <span class="n">entity_manytomany_field</span> <span class="o">=</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;_set&quot;</span>

                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="p">,</span>
                        <span class="n">related_entity_function_name</span><span class="p">,</span>
                        <span class="n">create_function_from_manytomany_field_to_other_entity</span><span class="p">(</span>
                            <span class="n">entity_manytomany_field</span>
                        <span class="p">),</span>
                    <span class="p">)</span></div>

    <span class="c1"># Methods dealing with all entities</span>
    <span class="c1">####################################################################################################################</span>

    <span class="n">_all_entity_classes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_all_entity_names</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AbstractEntity.get_all_entity_classes"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_all_entity_classes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_entity_classes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of all python classes of the entities defined within this models&#39; module</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_classes</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">entity_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">entity_names</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity_class</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span>
            <span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">entity_class</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;apis_core.apis_entities.models&quot;</span>
                    <span class="ow">and</span> <span class="n">entity_name</span> <span class="o">!=</span> <span class="s2">&quot;ent_class&quot;</span>
                    <span class="ow">and</span> <span class="n">entity_name</span> <span class="o">!=</span> <span class="s2">&quot;AbstractEntity&quot;</span>
                <span class="p">):</span>

                    <span class="n">entity_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_class</span><span class="p">)</span>
                    <span class="n">entity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_classes</span> <span class="o">=</span> <span class="n">entity_classes</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_names</span> <span class="o">=</span> <span class="n">entity_names</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_classes</span></div>

<div class="viewcode-block" id="AbstractEntity.get_entity_class_of_name"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_entity_class_of_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_entity_class_of_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param entity_name: str : The name of an entity</span>
<span class="sd">        :return: The model class of the entity respective to the given name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">entity_class</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_entity_classes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">entity_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">entity_class</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not find entity class of name:&quot;</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractEntity.get_all_entity_names"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_all_entity_names">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_entity_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of all class names in lower case of the entities defined within this models&#39; module</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_entity_classes</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_all_entity_names</span></div>

    <span class="c1"># Methods dealing with related entities</span>
    <span class="c1">####################################################################################################################</span>

    <span class="n">_related_entity_field_names</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AbstractEntity.get_related_entity_field_names"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_entity_field_names">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_entity_field_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: a list of names of all ManyToMany field names relating to entities from the respective entity class</span>

<span class="sd">        E.g. for Person.get_related_entity_field_names() or person_instance.get_related_entity_field_names() -&gt;</span>
<span class="sd">        [&#39;event_set&#39;, &#39;institution_set&#39;, &#39;personB_set&#39;, &#39;personA_set&#39;, &#39;place_set&#39;, &#39;work_set&#39;]</span>

<span class="sd">        Note: this method depends on the &#39;generate_all_fields&#39; function of the EntityRelationFieldGenerator class </span>
<span class="sd">        which wires the ManyToMany Fields into the entities and respective relationtypes. </span>
<span class="sd">        This method is nevertheless defined here within AbstractEntity for documentational purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_entity_field_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_related_entity_field_names was not initialized yet.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_entity_field_names</span></div>

<div class="viewcode-block" id="AbstractEntity.add_related_entity_field_name"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.add_related_entity_field_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_related_entity_field_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entity_field_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param entity_field_name: the name of one of several ManyToMany fields created automatically</span>
<span class="sd">        :return: None</span>

<span class="sd">        Note: this method depends on the &#39;generate_all_fields&#39; function of the EntityRelationFieldGenerator class </span>
<span class="sd">        which wires the ManyToMany Fields into the entities and respective relationtypes. </span>
<span class="sd">        This method is nevertheless defined here within AbstractEntity for documentational purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_entity_field_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_related_entity_field_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_related_entity_field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_field_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_entity_instances"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_entity_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_entity_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of queryset of all entity instances which are somehow related to the calling entity instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">queryset_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entity_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_entity_names</span><span class="p">():</span>

            <span class="n">queryset</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;get_related_&quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;_instances&quot;</span><span class="p">)()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">queryset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queryset_list</span></div>

    <span class="c1"># Methods dealing with related relations</span>
    <span class="c1">####################################################################################################################</span>

<div class="viewcode-block" id="AbstractEntity.get_related_relation_classes"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relation_classes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_relation_classes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of python classes of the relations which are related to the respective entity class</span>

<span class="sd">        E.g. for Place.get_related_relation_classes() or place_instance.get_related_relation_classes() -&gt;</span>
<span class="sd">        [ InstitutionPlace, PersonPlace, PlaceEvent, PlacePlace, PlaceWork ]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO __sresch__ : check for best practice on local imports vs circularity problems.</span>
        <span class="kn">from</span> <span class="nn">apis_core.apis_relations.models</span> <span class="kn">import</span> <span class="n">AbstractRelation</span>

        <span class="k">return</span> <span class="n">AbstractRelation</span><span class="o">.</span><span class="n">get_relation_classes_of_entity_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_relation_field_names"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relation_field_names">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_relation_field_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of class names in lower case of the relations which are related to the respective entity class</span>

<span class="sd">        E.g. for Place.get_related_relation_names() or place_instance.get_related_relation_names() -&gt;</span>
<span class="sd">        [&#39;institutionplace_set&#39;, &#39;personplace_set&#39;, &#39;placeevent_set&#39;, &#39;placeplace_set&#39;, &#39;placework_set&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO __sresch__ : check for best practice on local imports vs circularity problems.</span>
        <span class="kn">from</span> <span class="nn">apis_core.apis_relations.models</span> <span class="kn">import</span> <span class="n">AbstractRelation</span>

        <span class="k">return</span> <span class="n">AbstractRelation</span><span class="o">.</span><span class="n">get_relation_field_names_of_entity_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_relation_instances"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relation_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_relation_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of queryset of all relation instances which are somehow related to the calling entity instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">queryset_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">relation_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_relation_classes</span><span class="p">():</span>

            <span class="n">q_args</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">relation_class</span><span class="o">.</span><span class="n">get_related_entity_classA</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
                <span class="n">q_args</span> <span class="o">|=</span> <span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">relation_class</span><span class="o">.</span><span class="n">get_related_entity_field_nameA</span><span class="p">():</span> <span class="bp">self</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">relation_class</span><span class="o">.</span><span class="n">get_related_entity_classB</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
                <span class="n">q_args</span> <span class="o">|=</span> <span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">relation_class</span><span class="o">.</span><span class="n">get_related_entity_field_nameB</span><span class="p">():</span> <span class="bp">self</span><span class="p">})</span>

            <span class="n">queryset</span> <span class="o">=</span> <span class="n">relation_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">q_args</span><span class="p">)</span>
            <span class="n">queryset_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">queryset</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">queryset_list</span></div>

    <span class="c1"># Methods dealing with related relationtypes</span>
    <span class="c1">####################################################################################################################</span>

    <span class="n">_related_relationtype_classes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_related_relationtype_field_names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_related_relationtype_names</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AbstractEntity.get_related_relationtype_classes"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relationtype_classes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_relationtype_classes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of python classes of the relation types which are related to the respective entity class</span>

<span class="sd">        E.g. for Place.get_related_relation_classes() or place_instance.get_related_relation_classes() -&gt;</span>
<span class="sd">        [ InstitutionPlaceRelation, PersonPlaceRelation, PlaceEventRelation, PlacePlaceRelation, PlaceWorkRelation ]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_classes</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">relationtype_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">relationtype_names</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># TODO __sresch__ : check for best practice on local imports vs circularity problems.</span>
            <span class="kn">from</span> <span class="nn">apis_core.apis_vocabularies.models</span> <span class="kn">import</span> <span class="n">AbstractRelationType</span>

            <span class="k">for</span> <span class="p">(</span>
                <span class="n">relationtype_class</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">AbstractRelationType</span><span class="o">.</span><span class="n">get_all_relationtype_classes</span><span class="p">():</span>

                <span class="n">relationtype_name</span> <span class="o">=</span> <span class="n">relationtype_class</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">relationtype_name</span><span class="p">:</span>

                    <span class="n">relationtype_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relationtype_class</span><span class="p">)</span>
                    <span class="n">relationtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relationtype_name</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_classes</span> <span class="o">=</span> <span class="n">relationtype_classes</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_names</span> <span class="o">=</span> <span class="n">relationtype_names</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_classes</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_relationtype_names"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relationtype_names">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_relationtype_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of class names in lower case of the relation types which are related to the respective entity class</span>

<span class="sd">        E.g. for Place.get_related_relation_classes() or place_instance.get_related_relation_classes() -&gt;</span>
<span class="sd">        [ &#39;institutionplacerelation&#39;, &#39;personplacerelation&#39;, &#39;placeeventrelation&#39;, &#39;placeplacerelation&#39;, &#39;placeworkrelation&#39; ]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">get_related_relationtype_classes</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_names</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_relationtype_field_names"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relationtype_field_names">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_related_relationtype_field_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: a list of names of all ManyToMany field names relating to relationtypes from the respective entity class</span>

<span class="sd">        E.g. for PersonPerson.get_related_relationtype_field_names() or person_instance.get_related_relationtype_field_names() -&gt;</span>
<span class="sd">        [&#39;event_relationtype_set&#39;, &#39;institution_relationtype_set&#39;, &#39;personB_relationtype_set&#39;, &#39;personA_relationtype_set&#39;, &#39;place_relationtype_set&#39;, &#39;work_relationtype_set&#39;]</span>

<span class="sd">        Note: this method depends on the &#39;generate_all_fields&#39; function of the EntityRelationFieldGenerator class </span>
<span class="sd">        which wires the ManyToMany Fields into the entities and respective relationtypes. </span>
<span class="sd">        This method is nevertheless defined here within AbstractEntity for documentational purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_field_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;_related_relationtype_field_names was not initialized yet.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_field_names</span></div>

<div class="viewcode-block" id="AbstractEntity.add_related_relationtype_field_name"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.add_related_relationtype_field_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_related_relationtype_field_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">relationtype_field_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param entity_field_name: the name of one of several ManyToMany fields created automatically</span>
<span class="sd">        :return: None</span>

<span class="sd">        Note: this method depends on the &#39;generate_all_fields&#39; function of the EntityRelationFieldGenerator class </span>
<span class="sd">        which wires the ManyToMany Fields into the entities and respective relationtypes. </span>
<span class="sd">        This method is nevertheless defined here within AbstractEntity for documentational purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_field_names</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_field_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_related_relationtype_field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relationtype_field_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractEntity.get_related_relationtype_instances"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.AbstractEntity.get_related_relationtype_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_relationtype_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: list of queryset of all relationtype instances which are somehow related to the calling entity instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">queryset_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entity_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_entity_names</span><span class="p">():</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">entity_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>

                <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;_relationtype_set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">querysetA</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;A_relationtype_set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">querysetB</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;B_relationtype_set&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">queryset</span> <span class="o">=</span> <span class="n">querysetA</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">querysetB</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">queryset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">queryset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queryset_list</span></div></div>


<div class="viewcode-block" id="Person"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Person">[docs]</a><span class="nd">@reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">AbstractEntity</span><span class="p">):</span>

    <span class="n">GENDER_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;female&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;third gender&quot;</span><span class="p">,</span> <span class="s2">&quot;third gender&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The personss forename. In case of more then one name...&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">profession</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">ProfessionType</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Title</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">GENDER_CHOICES</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

<div class="viewcode-block" id="Person.save"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Person.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">:</span>
            <span class="c1"># secure correct unicode encoding</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">!=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&quot;NFC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&quot;NFC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="Place"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Place">[docs]</a><span class="nd">@reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Place</span><span class="p">(</span><span class="n">AbstractEntity</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">PlaceType</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span>
    <span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">)</span>
    <span class="n">lng</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Place.save"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Place.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lng</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;distinct&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Place</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="Institution"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Institution">[docs]</a><span class="nd">@reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Institution</span><span class="p">(</span><span class="n">AbstractEntity</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">InstitutionType</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Event">[docs]</a><span class="nd">@reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">AbstractEntity</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">EventType</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="Work"><a class="viewcode-back" href="../../../modules/entities.html#apis_core.apis_entities.models.Work">[docs]</a><span class="nd">@reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Work</span><span class="p">(</span><span class="n">AbstractEntity</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">WorkType</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">)</span></div>


<span class="n">a_ents</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;APIS_ADDITIONAL_ENTITIES&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prepare_fields_dict</span><span class="p">(</span><span class="n">fields_list</span><span class="p">,</span> <span class="n">vocabs</span><span class="p">,</span> <span class="n">vocabs_m2m</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">])(</span><span class="o">**</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vocabs</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;apis_vocabularies.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">vocabs_m2m</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;apis_vocabularies.</span><span class="si">{</span><span class="n">v2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="n">ents_cls_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">a_ents</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">a_ents</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ents_file</span><span class="p">:</span>
        <span class="n">ents</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ents_file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">CLoader</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ents</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">ents</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">prepare_fields_dict</span><span class="p">(</span>
                <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">],</span> <span class="n">ent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vocabs&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">ent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vocabs_m2m&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>
            <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;__module__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="vm">__name__</span>
            <span class="n">ent_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ent</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">AbstractEntity</span><span class="p">,),</span> <span class="n">attributes</span><span class="p">)</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="n">ent</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ent_class</span>
            <span class="n">ents_cls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent_class</span><span class="p">)</span>
            <span class="n">reversion</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ent_class</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tempentityclass_ptr&quot;</span><span class="p">])</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;create_default_uri&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_default_uri</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sender</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Person</span><span class="p">,</span> <span class="n">Institution</span><span class="p">,</span> <span class="n">Place</span><span class="p">,</span> <span class="n">Work</span><span class="p">,</span> <span class="n">Event</span><span class="p">]</span> <span class="o">+</span> <span class="n">ents_cls_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">BASE_URI</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">base1</span> <span class="o">=</span> <span class="n">BASE_URI</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base1</span> <span class="o">=</span> <span class="n">BASE_URI</span>
        <span class="n">uri_c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">base1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;GetEntityGenericRoot&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">}),</span>
        <span class="p">)</span>
        <span class="n">uri2</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri_c</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;apis default&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">uri2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="n">lst_entities_complete</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">x</span><span class="p">],</span> <span class="n">models</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ModelBase</span><span class="p">)</span>
    <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;apis_core.apis_entities.models&quot;</span>
    <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;AbstractEntity&quot;</span>
    <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">x</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">lst_entities_complete</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lst_entities_complete</span><span class="p">))</span>
<span class="n">perm_change_senders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;collection&quot;</span><span class="p">),</span> <span class="s2">&quot;through&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst_entities_complete</span>
<span class="p">]</span> <span class="c1"># TODO: Inspect. This list here will contain only duplicates if `lst_entities_complete` contains all entities</span>


<span class="nd">@receiver</span><span class="p">(</span>
    <span class="n">m2m_changed</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;create_object_permissions&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">create_object_permissions</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pre_add&quot;</span> <span class="ow">and</span> <span class="n">sender</span> <span class="ow">in</span> <span class="n">perm_change_senders</span><span class="p">:</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk_set&quot;</span><span class="p">]):</span>
            <span class="n">perms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">groups_allowed</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;change_&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;delete_&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;post_remove&quot;</span> <span class="ow">and</span> <span class="n">sender</span> <span class="ow">in</span> <span class="n">perm_change_senders</span><span class="p">:</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">perms_keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk_set&quot;</span><span class="p">]):</span>
            <span class="n">perms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">groups_allowed</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">perms_keep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">groups_allowed</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="n">rm_perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms_keep</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rm_perms</span><span class="p">:</span>
            <span class="n">remove_perm</span><span class="p">(</span><span class="s2">&quot;change_&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
            <span class="n">remove_perm</span><span class="p">(</span><span class="s2">&quot;delete_&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span>
    <span class="n">m2m_changed</span><span class="p">,</span>
    <span class="n">sender</span><span class="o">=</span><span class="n">Collection</span><span class="o">.</span><span class="n">groups_allowed</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
    <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;add_usergroup_collection&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">add_usergroup_collection</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pre_add&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pk_set&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Person</span><span class="p">,</span> <span class="n">Institution</span><span class="p">,</span> <span class="n">Place</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Work</span><span class="p">]:</span>
                    <span class="n">assign_perm</span><span class="p">(</span>
                        <span class="n">z</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="n">instance</span><span class="p">),</span>
                    <span class="p">)</span>


<span class="k">if</span> <span class="s2">&quot;registration&quot;</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;INSTALLED_APPS&quot;</span><span class="p">,</span> <span class="p">[]):</span>
    <span class="kn">from</span> <span class="nn">registration.backends.simple.views</span> <span class="kn">import</span> <span class="n">RegistrationView</span>
    <span class="kn">from</span> <span class="nn">registration.signals</span> <span class="kn">import</span> <span class="n">user_registered</span>

    <span class="nd">@receiver</span><span class="p">(</span>
        <span class="n">user_registered</span><span class="p">,</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">RegistrationView</span><span class="p">,</span>
        <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;add_registered_user_to_group&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_user_to_group</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user_group</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;APIS_AUTO_USERGROUP&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">user_group</span><span class="p">))</span>


<span class="c1"># Call the field generation function here, after all relevant entity classes have been defined above</span>
<span class="n">EntityRelationFieldGenerator</span><span class="o">.</span><span class="n">generate_all_fields</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Matthias Schlgl.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>