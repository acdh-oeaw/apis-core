{% extends "webpage/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block scriptHeader %}
{{ block.super }}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.2.1/bootstrap-slider.min.js" integrity="sha256-rjNVc4p9W5ytzudhfdvmen38QnQTPHD6izDAF9nA95w=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.2.1/css/bootstrap-slider.css" integrity="sha256-fyvdwFZ10EzDoLhbbG8gpn2ll8lqkABsEbGWrG18WOU=" crossorigin="anonymous" />
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/sigma.core.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/conrad.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/utils/sigma.utils.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/utils/sigma.polyfills.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/sigma.settings.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/classes/sigma.classes.dispatcher.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/classes/sigma.classes.configurable.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/classes/sigma.classes.graph.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/classes/sigma.classes.camera.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/classes/sigma.classes.quad.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/captors/sigma.captors.mouse.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/captors/sigma.captors.touch.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/sigma.renderers.canvas.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/sigma.renderers.webgl.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/sigma.renderers.svg.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/sigma.renderers.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/webgl/sigma.webgl.edges.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.utils.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.nodes.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.edges.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.edges.curve.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.edges.curvedArrow.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.labels.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/renderers/svg/sigma.svg.hovers.def.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/middlewares/sigma.middlewares.rescale.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/middlewares/sigma.middlewares.copy.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/misc/sigma.misc.animation.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/misc/sigma.misc.bindEvents.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/misc/sigma.misc.bindDOMEvents.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/src/misc/sigma.misc.drawHovers.js"></script>
<!-- end sigma IMPORTS -->
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.parsers.json/sigma.parsers.json.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.parsers.gexf/sigma.parsers.gexf.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.plugins.animate/sigma.plugins.animate.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.plugins.filter/sigma.plugins.filter.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.layouts.forceLink/worker.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.layouts.forceLink/supervisor.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.plugins.animate/sigma.plugins.animate.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.layouts.fruchtermanReingold/sigma.layout.fruchtermanReingold.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.plugins.tooltips/sigma.plugins.tooltips.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.exporters.json/sigma.exporters.json.js"></script>
<script src="{{ SHARED_URL }}apis/libraries/linkurious.js/plugins/sigma.exporters.graphml/sigma.exporters.graphml.js"></script>

<style type="text/css">

html, body, #content, #content > .panel, .panel-body, div.row {
   	width: 100%;
	height: 100%;
   }
div.col-md-9 {
	height: 100%;
}
      #graph-container {

      min-height: 900px;
      width:100%;
      height:100%;
      margin:auto;
    }

    ul.dropdown-menu {
      z-index: 2000;
    }

    .sigma-tooltip {
      max-width: 240px;
      max-height: 280px;
      background-color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 6px;
    }
    .sigma-tooltip-header {
      font-variant: small-caps;
      font-size: 120%;
      color: #437356;
      border-bottom: 1px solid #aac789;
      padding: 10px;
    }
    .sigma-tooltip-body {
      padding: 10px;
    }
    .sigma-tooltip-body th {
      color: #999;
      text-align: left;
    }
    .sigma-tooltip-footer {
      padding: 10px;
      border-top: 1px solid #aac789;
    }
    .sigma-tooltip > .arrow {
      border-width: 10px;
      position: absolute;
      display: block;
      width: 0;
      height: 0;
      border-color: transparent;
      border-style: solid;
    }
    .sigma-tooltip.top {
      margin-top: -12px;
    }
    .sigma-tooltip.top > .arrow {
      left: 50%;
      bottom: -10px;
      margin-left: -10px;
      border-top-color: rgb(249, 247, 237);
      border-bottom-width: 0;
    }
    .sigma-tooltip.bottom {
      margin-top: 12px;
    }
    .sigma-tooltip.bottom > .arrow {
      left: 50%;
      top: -10px;
      margin-left: -10px;
      border-bottom-color: rgb(249, 247, 237);
      border-top-width: 0;
    }
    .sigma-tooltip.left {
      margin-left: -12px;
    }
    .sigma-tooltip.left > .arrow {
      top: 50%;
      right: -10px;
      margin-top: -10px;
      border-left-color: rgb(249, 247, 237);
      border-right-width: 0;
    }
    .sigma-tooltip.right {
      margin-left: 12px;
    }
    .sigma-tooltip.right > .arrow {
      top: 50%;
      left: -10px;
      margin-top: -10px;
      border-right-color: rgb(249, 247, 237);
      border-left-width: 0;
    }
    #filter_network {
    position: absolute;
    top:10px;
    right: 5px;
    z-index:1000;
    max-width: 500px;
    }
    span.select2 {
    max-width: 480px;
    }
    #label-threshold .slider-selection {
	background: #BABABA;
}
    #filter_network option, #filter_network label {
    text-transform:capitalize;
}

    </style>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-heading">
            <h2>Network Visualization</h2>
        </div>
        <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div id="filter-container">
                    {% crispy form %}
                </div>
    	    <hr/>
    	    <div id="interaction-form">
    		    <input id="label-threshold" data-slider-id='threhSlider' type="text" data-slider-min="1" data-slider-max="30" data-slider-step="1" data-slider-value="8"/>
    		    <button type="submit" class="btn btn-default" id="toggle-force-link">Start Forcelink</button>
    	    </div>
                <hr/>
                <div id="export-form">
                    <form class="form-inline" id="create-file-form">
                        <div class="form-group">
                            <label for="select-format">Format</label>
                            <select class="form-control" id="select-format">
                                <option>Json</option>
                                <option>Graphml</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="checkbox">
                            <label>
                            <input type="checkbox" id="choice-download"> Download?
                            </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-default" id="create-button">Create</button>
                        </div>
                    </form>
                </div>
            <hr/>
          </div>

            <div class="col-md-9">
    		<div id="graph-container"><div id="filter_network">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingNetworkFilter">
                              <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseNetworkFilter" aria-expanded="false" aria-controls="collapseNetworkFilter">
                                    Filter
                                </a>
                              </h4>
                            </div>
                            <div id="collapseNetworkFilter" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingNetworkFilter">
                              <div class="panel-body">

    				<form class="form" id="filter2-form">

    				    <div class="form-group">
    					<label for="filter3-label">Name contains</label>
    					<input class="form-control" id="filter3-label">
    				    </div>
    				</form>
                              </div>
                            </div>
                          </div>
    			</div></div>
            </div>
        </div>
    </div>
</div></div>
{% endblock %}

{% block scripts %}
{{block.super}}
<script type="text/javascript">
	$("#interaction-form").on( "click", "#toggle-force-link", function(e) {
		e.preventDefault();
		sigma.layouts.startForceLink($.ApisNet.instance);
	});
$('#interaction-form').on("change", "#label-threshold", function(e){
	e.preventDefault();
	var threshold = $('#label-threshold').val()
	$.ApisNet.instance.settings({'labelThreshold': threshold});
	$.ApisNet.instance.refresh();
});
$( "div#content" ).on( "click", "#filter2-button", function(e) {
	e.preventDefault();
$.ApisNet.selected_nodes = new Array();
	console.log("click worked");
	var filters = new Object();
	for (var f in $.ApisNet.filter.list_node_filters) {
		filters[f] = $('#filter2-'+f).val()
	}
	console.log(filters);
        $.ApisNet.instance.graph.nodes().forEach(function (n) {
		var test = false;
		var label_contains = $('#filter3-label').val()
		if (label_contains != null) {
			if (n.label.includes(label_contains)) {
			test = true;
			} else {
			test = false;
			return;
			}
		}
		for (var f2 in filters){
			if (f2 == 'type') {
			var d = n
			} else {
			var d = n.data
			}
			if (filters[f2] != null) {
				var test2 = false
				if ($.isArray(d[f2])){
				for (var i = 0; i < d[f2].length; i++){
					if (filters[f2].includes(d[f2][i])){
					test2 = true
					}
				}
				} else {
					if (filters[f2].includes(d[f2])){
					test2 = true
					}
				}
				if (test2){
				test = true
				} else {
				test = false;
				break;
				}
			}
		}
		if (test) {
		n.color = '#f4e242';
		$.ApisNet.selected_nodes.push(n);
		}

	}
)

     $.ApisNet.instance.refresh();
})
function download_network_data(formData) {
    $.ajax({
          type: 'POST',
          url: '{% url "apis:apis_core:NetJson-list" %}',
          data: formData,
          beforeSend: function(request) {
                  var csrftoken = getCookie('csrftoken');
                    request.setRequestHeader("X-CSRFToken", csrftoken);
            },
          success: function(data, s, xhr) {
              $.ApisNet.instance.graph.read(data);
              $.ApisNet.instance.graph.nodes().forEach(function (n) {
                    $.ApisNet.nodes_pk.push(n.id);

      n.x = Math.random();
      n.y = Math.random();
      n.size = 10*(1-1/$.ApisNet.instance.graph.degree(n.id));
      if (n.type === 'person') {
        n.color = '#5FB404';
      } else if (n.type === 'institution') {
        n.color = '#B40404';
      } else if (n.type === 'place') {
          n.color = '#4286f4'
      } else if (n.type === 'event') {
          n.color = '#f4f142'
      } else {
          n.color = '#a8a8a8'
      };
		      console.log(n);
		      for (var key in $.ApisNet.filter.list_node_filters) {
			      if (key in n.data){
				      if ($.isArray(n.data[key])){
					      for (var i3 = 0; i3 < n.data[key].length; i3++) {
			      if (!$.ApisNet.filter.list_node_filters[key].values.includes(n.data[key][i3])) {
			     				$.ApisNet.filter.list_node_filters[key].values.push(n.data[key][i3]);
				      			$.ApisNet.filter.list_node_filters[key].select2.push({id: n.data[key][i3], text: n.data[key][i3]})
			      }}
				      }
				      else {
			      if (!$.ApisNet.filter.list_node_filters[key].values.includes(n.data[key])) {
			      $.ApisNet.filter.list_node_filters[key].values.push(n.data[key]);
				      $.ApisNet.filter.list_node_filters[key].select2.push({id: n.data[key], text: n.data[key]})}}
			      } else if (key == 'type') {
			      if (!$.ApisNet.filter.list_node_filters[key].values.includes(n[key])) {
			      $.ApisNet.filter.list_node_filters[key].values.push(n[key]);
				      $.ApisNet.filter.list_node_filters[key].select2.push({id: n[key], text: n[key]})
			      };

			      }

			      };

  });
       if (typeof $.ApisNet.form_data_load !== 'undefined'){
           if ($.ApisNet.form_data_load.length > 0) {
               var form = $.ApisNet.form_data_load.shift();
               download_network_data(form);
           }
       }

     $.ApisNet.instance.refresh();
     sigma.layouts.startForceLink($.ApisNet.instance);
		  for (var key in $.ApisNet.filter.list_node_filters) {

		$("#filter2-"+key).select2({
		data: $.ApisNet.filter.list_node_filters[key].select2
		})
		  }
          }

    })
}

function delete_nodes(e) {
    $.ApisNet.instance.graph.dropNode(e.data['node']['id']);
    $.ApisNet.instance.refresh();
    e.stopPropagation();
    e.preventDefault();

};

function delete_nodes_2(e) {
    $.ApisNet.instance.graph.dropNode(e);
    $.ApisNet.instance.refresh();
};

function process_selected_nodes(e) {
    if (e['keyCode'] === 46) {
        for (i = 0; i < $.ApisNet.selected_nodes.length; i++) {
            delete_nodes_2($.ApisNet.selected_nodes[i]['id']);
        };
        $.ApisNet.selected_nodes = new Array();
    } else if (e.keyCode == 69 && e.ctrlKey) {
        e.stopPropagation();
        e.preventDefault();
        if (typeof $.ApisNet.nodes_expand == 'undefined') {
            $.ApisNet.nodes_expand = new Array();
        }
        var list_nodes_2 = $.ApisNet.selected_nodes;
        for (i = 0; i < list_nodes_2.length; i++) {
            var node_id = list_nodes_2[i]['id'];
            var node_type = list_nodes_2[i]['type'];
            node_type = node_type[0].toUpperCase()+node_type.substring(1, node_type.length);
            var new_node = [node_type, node_id]
            $.ApisNet.nodes_expand.push(new_node)
        };
        expand_nodes();
        $.ApisNet.selected_nodes = new Array();
    }
};

function select_unselect_node(e) {
    var node = e.data['node'];
    $.ApisNet.instance.graph.nodes(e.data['node']['id']).color = '#f4e242';
    if ($.ApisNet.selected_nodes.includes(node)) {
        var n = node;
        if (n.type === 'person') {
                    n.color = '#5FB404';
                } else if (n.type === 'institution') {
                    n.color = '#B40404';
                } else if (n.type === 'place') {
                    n.color = '#4286f4'
                } else if (n.type === 'event') {
                    n.color = '#f4f142'
                } else {
                    n.color = '#a8a8a8'
                };
        $.ApisNet.selected_nodes.splice( $.inArray(n, $.ApisNet.selected_nodes), 1 );
    } else {
        $.ApisNet.selected_nodes.push(node);

    }
    $.ApisNet.instance.refresh();
};

function expand_nodes() {
if (typeof $.ApisNet.form_data_load == 'undefined') {
    $.ApisNet.form_data_load = new Array();
};
for (i2 = 0; i2 < $.ApisNet.nodes_expand.length; i2++) {
    var node_id = $.ApisNet.nodes_expand[i2][1];
    var node_type = $.ApisNet.nodes_expand[i2][0];
    console.log(node_type);
    for (i = 0; i < $.ApisNet.relation_types.length; i++) {
        var formData = {};
        if ($.ApisNet.relation_types[i].startsWith(node_type.toLowerCase())) {
            formData.search_source = node_id;
            formData.select_relation = $.ApisNet.relation_types[i];
        }
        ;
        if ($.ApisNet.relation_types[i].endsWith(node_type.toLowerCase())) {
            formData.search_target = node_id;
            formData.select_relation = $.ApisNet.relation_types[i];
        }
        ;

        $.ApisNet.form_data_load.push(formData);
    }
}
var form2 = $.ApisNet.form_data_load.shift()
    download_network_data(form2);
$.ApisNet.nodes_expand = new Array();
};

function expand_node(node_type, node_id){
    if (typeof $.ApisNet.nodes_expand == 'undefined') {
            $.ApisNet.nodes_expand = new Array();
        };
  $.ApisNet.nodes_expand.push([node_type, node_id]);
  $.ApisNet.tooltip.close();
  expand_nodes();
};
function add_file_list(data, s, xhr) {
    var file_name = data['file_name'].split('/')[2]
    if ($('#list_created_graphs').length) {
        var html = '<li class="list-group-item"><a href="'
        html += data['file_name']
        html += '">'+file_name+'</a></li>'
        $('#list_created_graphs').append(html)
    } else {
        var html = '<div class="panel panel-default top-buffer"><div class="panel-heading">Files</div><div class="panel-body"><ul class="list-group" id="list_created_graphs">'
        html += '<li class="list-group-item"><a href="'
        html += data['file_name']
        html += '">'+file_name+'</a></li></ul></div></div>'
        $('#export-form').nextAll('hr').append(html)
    }
};
function unbind_create_file_form(){
    $("form#create-file-form").submit(function(event) {
        event.preventDefault();
        event.stopPropagation();
        var download = $("input#choice-download").is(":checked");
        var format = $("select#select-format").val();
        var dt = new Date();
        var month = dt.getMonth()+1
        var date = dt.getFullYear() + "_" + month + "_" + dt.getDate();
        var user = '{{ request.user.username }}'
        if ($.ApisNet.instance) {
            if (download) {
                if (format=='Json') {
                    $.ApisNet.instance.toJSON({
                      download: true,
                      filename: 'apisGraph_'+user+'_'+date+'.json'
                    });
                }
                if (format=='Graphml') {
                    console.log($.ApisNet.instance)
                    $.ApisNet.instance.toGraphML({
                      download: true,
                      filename: 'apisGraph_'+user+'_'+date+'.graphml',
                      edgesAttributes: 'data',
                      nodesAttributes: 'data',
                      renderer: $.ApisNet.instance.renderers[0],
                      undirectedEdges: false
                    });
                }
            } else {
                if (format=='Json') {
                    var file = $.ApisNet.instance.toJSON({
                      download: false,
                    });

                   // file = file.replace(',"edges":[{', ',"links":[{')

                } else if (format=='Graphml') {

                    var file = $.ApisNet.instance.toGraphML();
                }
                $.ajax({
                        type: 'POST',
                        url: '/api2/savenetworkfiles/',
                        data: {'file': file, 'file_name': 'apisGraph_' + user + '_' + date + '.json'},
                        success: add_file_list,
                    })
            }
        }
    }
    )
};
function unbind_net_viz_form(){
    $("form.FilterNodesForm").submit(function(event) {
            event.preventDefault();
            event.stopPropagation();
            var type_relation = $('#id_select_relation').val();
            if (!$.ApisNet.relation_types.includes(type_relation)) {
                $.ApisNet.relation_types.push(type_relation);
            }
            var formData = $(this).serialize();
            //var button_text = $(this).find(':button').text();
          download_network_data(formData)
          })
}

$( document ).ready(function() {
var list_filters_2 = ['type', 'profession', 'gender']
unbind_net_viz_form();
unbind_create_file_form();
$("#graph-container").on("contextmenu", function(e) { e.preventDefault(); });
$(document).keydown(process_selected_nodes);
if (!$.ApisNet) {
    $.ApisNet = {};
    $.ApisNet.relation_types = new Array();
    $.ApisNet.nodes_pk = new Array();
    $.ApisNet.selected_nodes = new Array();
    $.ApisNet.instance = new sigma('graph-container');
    $.ApisNet.instance.settings({
  minNodeSize: 5,
  maxNodeSize: 15,
    animationsTime: 4500,
  skip_existing_nodes: true,
  skip_existing_edges: true
})
    $.ApisNet.filter = new Object();
    $.ApisNet.filter.list_node_filters = new Object();
	var i;
	for (i = 0; i < list_filters_2.length; i++){
		$.ApisNet.filter.list_node_filters[list_filters_2[i]] = {values: [], select2: []}
		$('#filter2-form').append('<div class="form-group">\
					<label for="filter2-'+list_filters_2[i]+'">'+list_filters_2[i]+'</label>\
					<select class="form-control" id="filter2-'+list_filters_2[i]+'" multiple="multiple">\
					</select>\
				    </div>')
		console.log(list_filters_2[i])
	}
			$('#filter2-form').append('<div class="form-group">\
					<button type="filter" class="btn btn-default" id="filter2-button">Filter</button>\
				    </div>')
    $.ApisNet.filter.filter = new sigma.plugins.filter($.ApisNet.instance);
    sigma.layouts.configForceLink($.ApisNet.instance, {
      worker: true,
      barnesHutOptimize: false,
      autoStop: true,
      background: true,
      easing: 'cubicInOut'
    });
var config = {
      node: [{
        show: 'clickNode',
        cssClass: 'sigma-tooltip',
        position: 'top',
        hide: 'clickStage',
        renderer: function(node) {
          // The function context is s.graph
          // Returns an HTML string:
          return node.tooltip;
          // Returns a DOM Element:
          //var el = document.createElement('div');
          //return el.innerHTML = Mustache.render(template, node);
        }
      }],
    };
    // Instanciate the tooltips plugin with a Mustache renderer for node tooltips:
    $.ApisNet.tooltip = sigma.plugins.tooltips($.ApisNet.instance, $.ApisNet.instance.renderers[0], config);
//$.ApisNet.instance.bind("rightClickNode", delete_nodes);
    $.ApisNet.instance.bind("rightClickNode", select_unselect_node);

};
$('#label-threshold').slider({
	value: $.ApisNet.instance.settings('labelThreshold'),
	formatter: function(value) {
		return 'Current value: ' + value;
	}
});
$('#id_select_relation').on("change", function(){
    var list_ent = $(this).val().split('-')
    console.log(list_ent);
    //$('#id_select_kind-autocomplete').yourlabsAutocomplete('destroy');
    //$('#id_select_kind-autocomplete').yourlabsAutocomplete({'url': new_val, 'minimumCharacters': 2});

    $('#id_search_source').select2('destroy');
    $('#id_search_source').select2({
          ajax: {
            url: "{% url 'apis_core:apis_entities:generic_network_entities_autocomplete' 334488  %}".replace("334488", list_ent[0].toString()),
            dataType: 'json'
            // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
          }
        });
    $('#id_search_target').select2('destroy');
    $('#id_search_target').select2({
        allowClear: true,
          ajax: {
            url: "{% url 'apis_core:apis_entities:generic_network_entities_autocomplete' 334488 %}".replace("334488", list_ent[1].toString()),
            dataType: 'json'
            // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
          }
        });
    $('#id_select_kind').select2('destroy');
    $('#id_select_kind').select2({
        allowClear: true,
          ajax: {
            url: "{% url 'apis_core:apis_vocabularies:generic_vocabularies_autocomplete' 223344 'normal' %}".replace("223344", list_ent[0]+list_ent[1]+'relation'),
            dataType: 'json'
            // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
          }
        });
    //$('#id_search_target-autocomplete').yourlabsAutocomplete('destroy');
    //$('#id_search_target-autocomplete').yourlabsAutocomplete({'url': new_val_target, 'minimumCharacters': 2});
})
})
</script>
{% endblock %}
